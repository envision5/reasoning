<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>o1 - Ollama Reasoning Chains</title>
    <!-- Style section remains unchanged -->
    <style>
        /* ... (keep all existing styles) ... */
    </style>
</head>
<body>
    <div class="header">
        <h1>o1: Ollama Reasoning Chains</h1>
        <p>A vanilla JavaScript implementation of o1-like reasoning chains using Ollama</p>
    </div>

    <div class="config">
        <h3>Current Configuration:</h3>
        <p>Ollama URL: <code id="ollamaUrl">http://127.0.0.1:11434</code></p>
        <p>Ollama Model: <code id="ollamaModel">llama2</code></p>
    </div>

    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-container">
            <input type="text" class="message-input" id="userInput" 
                   placeholder="e.g., How many 'R's are in the word strawberry?" 
                   onkeypress="if(event.key === 'Enter') sendMessage()">
            <button class="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const SYSTEM_PROMPT = `You are an expert AI assistant with advanced reasoning capabilities. Your task is to provide detailed, step-by-step explanations of your thought process. For each step:

1. Provide a clear, concise title describing the current reasoning phase.
2. Elaborate on your thought process in the content section.
3. Decide whether to continue reasoning or provide a final answer.`;

        let messages = [];
        let thinking = false;

        async function makeApiCall(messages, maxTokens, isFinalAnswer = false) {
            try {
                // Create the prompt by combining system prompt and the last message
                const lastMessage = messages[messages.length - 1].content;
                const fullPrompt = `${SYSTEM_PROMPT}\n\nUser: ${lastMessage}`;

                const response = await fetch(`http://127.0.0.1:11434/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: document.getElementById('ollamaModel').textContent,
                        prompt: fullPrompt,
                        stream: false,
                        options: {
                            num_predict: maxTokens,
                            temperature: 0.2
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return JSON.parse(data.response);
            } catch (error) {
                console.error('API call failed:', error);
                return {
                    title: "Error",
                    content: `Failed to generate ${isFinalAnswer ? 'final answer' : 'step'}. Error: ${error.message}`,
                    next_action: isFinalAnswer ? undefined : "final_answer"
                };
            }
        }

        function addMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
            messageDiv.innerHTML = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function generateResponse(prompt) {
            thinking = true;
            let currentMessages = [
                { role: "system", content: SYSTEM_PROMPT },
                { role: "user", content: prompt },
                { role: "assistant", content: "Thank you! I will now think step by step following my instructions." }
            ];

            let stepCount = 1;

            while (thinking) {
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'thinking';
                thinkingDiv.textContent = 'Thinking...';
                document.getElementById('messages').appendChild(thinkingDiv);

                const stepData = await makeApiCall(currentMessages, 300);
                thinkingDiv.remove();

                const stepContent = `
                    <div class="step-title">Step ${stepCount}: ${stepData.title}</div>
                    <div class="step-content">${stepData.content}</div>
                `;
                addMessage(stepContent);

                currentMessages.push({ role: "assistant", content: JSON.stringify(stepData) });

                if (stepData.next_action === 'final_answer') {
                    break;
                }

                stepCount++;
            }

            currentMessages.push({ role: "user", content: "Please provide the final answer based on your reasoning above." });
            const finalData = await makeApiCall(currentMessages, 200, true);
            
            addMessage(`
                <div class="step-title">Final Answer</div>
                <div class="step-content">${finalData.content}</div>
            `);

            thinking = false;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message && !thinking) {
                input.value = '';
                addMessage(message, true);
                await generateResponse(message);
            }
        }
    </script>
</body>
</html>
